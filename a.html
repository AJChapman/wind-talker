<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FreeFlight Wx</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="http://freeflightwx.com/acthpa/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.1.0/js/bootstrap-toggle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
    <!-- Bootstrap -->
    <link href="http://freeflightwx.com/acthpa/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.1.0/css/bootstrap-toggle.min.css" rel="stylesheet">
    <link id="bsdp-css" href="http://freeflightwx.com/acthpa/bootstrap-datepicker/css/bootstrap-datepicker3.min.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    
<script type="application/javascript">
    var myVar;
    var count;
    function stopRefresh() {
        clearInterval(myVar);
    }
    function startRefresh() {
        myVar = setInterval(function(){ updateImage() }, 3000);
        count = 5;
    }
    function updateImage() {
        var image = document.getElementById("graph");
        image.src = 'http://freeflightwx.com/acthpa/springhill/windgraph.php?time=600&window=600&width=780&height=500&max=0&min=0&bol=0&markers=1&error=1&average=0&point=3&timeDisplay=true&rand=' + Math.random();
        count--;
        if(count <= 0){
            toggleOff();
        }
    }
    function toggleOff() {
        $('#toggle').prop('checked', false).change()
    }
    window.onload = function() {
        startRefresh();
    }
   
    function GetCurrentPageName() {
        //method to get Current page name from url.
        var PageURL = document.location.href;
        var PageName = PageURL.substring(PageURL.lastIndexOf('/') + 1);
        return PageName.toLowerCase() ;
    }
    
    function pad(num){
        return ('0'+num).slice(-2);
        
    }
    $(document).ready(function(){
        var CurrPage = GetCurrentPageName();
        switch(CurrPage){
            case 'index.php':
                $('#li_index').addClass('active') ;
                break;
            case '15mins.php':
                $('#li_15mins').addClass('active') ;
                break;
            case '1hour.php':
                $('#li_1hour').addClass('active') ;
                break;
            case '4hours.php':
                $('#li_4hours').addClass('active') ;
                break;
            case '12hours.php':
                $('#li_12hours').addClass('active') ;
                break;
            case 'day.php':
                $('#li_day').addClass('active') ;
                break;
            case 'table.php?h=1':
                $('#table').addClass('active') ;
                break;
        }
        
         $('#toggle').change(function(){
            if($('#toggle').is(':checked')) {
                updateImage();
                startRefresh();
            }
            else {
                stopRefresh();
            }
        });
        
        $.get("https://cors-anywhere.herokuapp.com/http://freeflightwx.com/acthpa/springhill/rawjson.php",{ t: "3600" , a: "600"},
                    function(data, status) {
                        
                        // EXTRACT VALUE FOR HTML HEADER. 
                        
                        var col = [];
                        for (var i = 0; i < data.length; i++) {
                            for (var key in data[i]) {
                                if (col.indexOf(key) === -1) {
                                    col.push(key);
                                }
                            }
                        }
                
                        // CREATE DYNAMIC TABLE.
                        var table = document.createElement("table");
                
                        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.
                
                        var tr = table.insertRow(-1);                   // TABLE ROW.
                
                        for (var i = 0; i < col.length; i++) {
                            var th = document.createElement("th");      // TABLE HEADER.
                            th.innerHTML = col[i];
                            tr.appendChild(th);
                        }
                
                        // ADD JSON DATA TO THE TABLE AS ROWS.
                        for (var i = 0; i < data.length; i++) {
                
                            tr = table.insertRow(-1);
                
                            for (var j = 0; j < col.length; j++) {
                                var tabCell = tr.insertCell(-1);
                                tabCell.innerHTML = data[i][col[j]];
                            }
                        }
                         $('#table').append(table);
                        
                        //Create a Pixi Application
                        let app = new PIXI.Application({width: 780, height: 500,  antialias: true});
                        app.renderer.backgroundColor = 0xffffff;
                        
                        //todo
                        var widthImage = 780;
                        var heightImage = 500
                        
                        //display params
                        var option_errorbars = true;
                        var option_max = true;
                        var option_min = true;
                        var option_markers = false;
                        var option_average = true;
                        var option_pointSize = 1;
                        var option_timeDisplay = true;
                        var option_nDir = false;
                        
                        
                        var widthMargin = 10;
                        var heightMargin = 20;
                        var speedMarginFactor = 1.1;
                        
                        //time params
                        var timeNum;
                        var timeName;
                        var timeHistory = 3000;
                        if(timeHistory <= 3600){
                            timeNum = timeHistory / 60;
                            timeName = 'minutes';
                        }
                        else{
                            timeNum = timeHistory / 3600;
                            timeName = 'hours';
                        }
                    
                        // date_default_timezone_set($site_timezone);
                        var currentTime = Date.now(); //current time in milliseconds since the epoch
                    	var earlyTime = currentTime - (timeHistory * 1000);//timeHistory seconds earlier than the current time in milliseconds since the epoch
                        
                        //site info
                        var site_name = 'Spring Hill';
                        var site_timezone = 'Australia/Sydney';
                        
                        //wind speed params
                        var siteSpeedLow = 13;
                        var siteSpeedOn = 18;
                        var siteSpeedMarginal = 22;
                        
                        //wind dir params
                        var siteDirOn = 280;
                        var siteDirWidth = 45;
                        
                        //otherParams
                        var siteAltitude = 2870; //alt in ft
                        var siteDirAdjust = 0;//direction adjustment
                        var siteMaxSpeed = 150;//max recordable wind speed to cancel out electrical interferrence
                        
                        //some data parameters to use
                    	var maxTime = 0;
                    // 	var minTime = $currentTime;
                    	var maxWindspeed = 0;
                    
                    	if(maxWindspeed < siteSpeedMarginal * speedMarginFactor){
                            maxWindspeed = siteSpeedMarginal;
                    
                        }
                        
                        
                        
                        //some layout paramaters
                        var plotLeft = widthMargin;
                        var plotRight = widthImage - (widthMargin * 6.0);
                        var plotWidth = plotRight - plotLeft;
                    
                        var plotTop = heightMargin;
                        var plotBottom = heightImage / 2.0;
                        var plotHeight = plotBottom - plotTop;
                    
                    	var yPixel = plotHeight / (maxWindspeed * speedMarginFactor);
                    
                    	var yLowMax = plotBottom - siteSpeedLow * yPixel;
                    	var yOnMax =  plotBottom - siteSpeedOn * yPixel;
                    	var yMarginalMax =  plotBottom - siteSpeedMarginal * yPixel;
                    
                    
                        let background = new PIXI.Graphics();
                        // background.lineStyle(1, 0x000000, 1, 0.5);
                        
                        //Low Rectangle
                        
                        background.beginFill(0x87ceeb);
                        background.drawRect(plotLeft, yLowMax, plotWidth, plotBottom - yLowMax);
                        
                        //On Rectangle
                        background.beginFill(0x008000);
                        background.drawRect(plotLeft, yOnMax, plotWidth,  yLowMax - yOnMax);
                        
                        //Marginal Rectangle
                        background.beginFill(0xffa500);
                        background.drawRect(plotLeft, yMarginalMax, plotWidth,  yOnMax - yMarginalMax);
                        
                        //Off Rectangle
                        background.beginFill(0xff0000);
                        background.drawRect(plotLeft, plotTop, plotWidth,  yMarginalMax - plotTop);
                        
                        background.endFill();
                        // background.beginFill(0x00ff00);
                        background.lineStyle(1, 0x000000, 1, 0);
                        background.moveTo(plotRight + 1, plotTop);
                        background.lineTo(plotRight + 1, plotBottom );
                        
                        //knt scale
                        var offsetRight = 25;
                        var speedConversionFactor = 1.15078;
                        var windMinorTickSize = 1;
                        for(var windTick = 0; windTick <= maxWindspeed * speedMarginFactor / speedConversionFactor; windTick += windMinorTickSize){
                            var x1 = offsetRight + plotRight + 1;
                            var x2 = offsetRight + plotRight + 3;
                            var y = plotBottom - windTick * yPixel * speedConversionFactor;
                            background.moveTo(x1, y);
                            background.lineTo(x2, y);
                        }
                    
                        var windMajorTickSize = 5;
                        
                        let style = new PIXI.TextStyle({fontSize: 12});
                        
                        for(var windTick = 0; windTick <= maxWindspeed * speedMarginFactor / speedConversionFactor; windTick += windMajorTickSize){
                            var x1 = offsetRight + plotRight + 1;
                            var x2 = offsetRight + plotRight + 6;
                            var y =  plotBottom - windTick * yPixel * speedConversionFactor;
                            background.moveTo(x1, y);
                            background.lineTo(x2, y);
                            
                            let text = new PIXI.Text("");
                            text.style = style;
                            text.text = windTick;
                            text.x = x2 + 2;
                            text.y = y + 4 - 12;
                            app.stage.addChild(text);
                        }
                        
                        let text = new PIXI.Text("knt");
                        text.style = style;
                        text.x = x1;
                        text.y = plotTop - 5 - 12;
                        app.stage.addChild(text);
                        
                        //kmh scale
                        var offsetRight = 0;
                        var speedConversionFactor = 0.621371;
                        var windMinorTickSize = 1;
                        for(var windTick = 0; windTick <= maxWindspeed * speedMarginFactor / speedConversionFactor; windTick += windMinorTickSize){
                            var x1 = offsetRight + plotRight + 1;
                            var x2 = offsetRight + plotRight + 3;
                            var y = plotBottom - windTick * yPixel * speedConversionFactor;
                            background.moveTo(x1, y);
                            background.lineTo(x2, y);
                        }
                    
                        var windMajorTickSize = 5;
                        
                        for(var windTick = 0; windTick <= maxWindspeed * speedMarginFactor / speedConversionFactor; windTick += windMajorTickSize){
                            var x1 = offsetRight + plotRight + 1;
                            var x2 = offsetRight + plotRight + 6;
                            var y =  plotBottom - windTick * yPixel * speedConversionFactor;
                            background.moveTo(x1, y);
                            background.lineTo(x2, y);
                            
                            let text = new PIXI.Text("");
                            text.style = style;
                            text.text = windTick;
                            text.x = x2 + 2;
                            text.y = y + 4 - 12;
                            app.stage.addChild(text);
                        }
                        
                        let text1 = new PIXI.Text("kmh");
                        text1.style = style;
                        text1.x = x1;
                        text1.y = plotTop - 5 - 12;
                        app.stage.addChild(text1);
                    
                        
                        
                        //time axis
                        background.moveTo(plotLeft, plotBottom );
                        background.lineTo(plotRight + 1, plotBottom);
                        
                        var currentTimeS = currentTime / 1000;
                        var earlyTimeS = earlyTime / 1000;
            
                        var timeMajorTickSizeMins;//minutes
                        var timeMinorTickSizeMins;//minutes
                        
                        var y1 = plotBottom + 1;
                        var y2 = plotBottom + 8;
                        if(timeName == 'hours'){
                            
                            timeMajorTickSizeMins = 60;//minutes
                            timeMinorTickSizeMins = 10;//minutes
                
                            var secondsSinceTick = currentTimeS % (60*timeMajorTickSizeMins);
                            var secondsSinceMinorTick = currentTimeS % (60*timeMinorTickSizeMins);
                            var lastTickTime = currentTimeS - secondsSinceTick;
                            var lastMinorTickTime = currentTimeS - secondsSinceMinorTick;
                
                            
                
                            for(var timeTickSec = lastTickTime; timeTickSec >= earlyTimeS; timeTickSec -= timeMajorTickSizeMins * 60){
                                
                                var x = plotRight - plotWidth * (currentTimeS - timeTickSec) / timeHistory;
                
                                background.moveTo(x, y1 );
                                background.lineTo(x, y2);
                                
                                if(timeTickSec != 0){
                                    var date = new Date(timeTickSec * 1000)
                                    let text = new PIXI.Text("");
                                    text.style = style;
                                    text.text = pad(date.getHours());
                                    text.x = x - 7;
                                    text.y = y2 + 15 - 12;
                                    app.stage.addChild(text);
                                    
                                }
                            }
                
                            
                        }
                        else{
                           
                            timeMajorTickSizeMins = 5;//minutes
                            timeMinorTickSizeMins = 1;//minutes
                
                            var secondsSinceTick = currentTimeS % (60*timeMajorTickSizeMins);
                            var secondsSinceMinorTick = currentTimeS % (60*timeMinorTickSizeMins);
                            var lastTickTime = currentTimeS - secondsSinceTick;
                            var lastMinorTickTime = currentTimeS - secondsSinceMinorTick;
                           
                
                            for(var timeTickSec = lastTickTime; timeTickSec >= earlyTimeS; timeTickSec -= timeMajorTickSizeMins * 60){
                                
                                var x = plotRight - plotWidth * (currentTimeS - timeTickSec) / timeHistory;
                
                                background.moveTo(x, y1 );
                                background.lineTo(x, y2);
                                
                                if(timeTickSec != 0){
                                    var date = new Date(timeTickSec * 1000)
                                    let text = new PIXI.Text("");
                                    text.style = style;
                                    text.text = pad(date.getHours()) + ":" + pad(date.getMinutes());
                                    text.x = x - 7;
                                    text.y = y2 + 15 - 12;
                                    app.stage.addChild(text);
                                    
                                }
                            }
                        }
                        
                        y2 = plotBottom + 4;
                
                        for(var timeTickSec = lastMinorTickTime; timeTickSec >= earlyTimeS; timeTickSec -= timeMinorTickSizeMins * 60){
                            var x = plotRight - plotWidth * (currentTimeS - timeTickSec) / timeHistory;
                            background.moveTo(x, y1 );
                            background.lineTo(x , y2);
                        }
                        app.stage.addChild(background);
                        
                        
                        
                        //Add the canvas that Pixi automatically created for you to the HTML document
                         $('#graph').append(app.view);
                     
                    }
               );
    });
</script>
<div class="container">
<!-- Static navbar -->
<nav class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../">Home</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li id="li_index"><a href="index.php">Current</a></li>
                <!--<li id="li_15mins"><a href="15mins.php">15 Mins</a></li>-->
                <li id="li_1hour"><a href="1hour.php">1 Hour</a></li>
                <li id="li_4hours"><a href="4hours.php">4 Hours</a></li>
                <li id="li_12hours"><a href="12hours.php">12 Hours</a></li>
                <li id="li_day"><a href="day.php">Day</a></li>
                <li id="li_table"><a href="table.php?h=24">Table</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>
<h3>Spring Hill Weather Station</h3>
</div>
<!--
<div class="container">
    <div class="checkbox">
        <label>
            <input id="toggle" type="checkbox" checked data-toggle="toggle" data-size="mini" data-onstyle="info" data-offstyle="warning">
            Auto refresh (every 3 seconds)
        </label>
    </div>
</div>
-->
<div class="container" id="graph">
  
</div>
<div class="container" id="table">
    
</div>
</body>
</html>
