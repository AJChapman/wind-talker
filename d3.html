<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FreeFlight Wx</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="http://freeflightwx.com/acthpa/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.1.0/js/bootstrap-toggle.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Bootstrap -->
    <link href="http://freeflightwx.com/acthpa/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.1.0/css/bootstrap-toggle.min.css" rel="stylesheet">
    <link id="bsdp-css" href="http://freeflightwx.com/acthpa/bootstrap-datepicker/css/bootstrap-datepicker3.min.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    
<script type="application/javascript">
    var myVar;
    var count;
    function stopRefresh() {
        clearInterval(myVar);
    }
    function startRefresh() {
        myVar = setInterval(function(){ updateImage() }, 3000);
        count = 5;
    }
    function updateImage() {
        var image = document.getElementById("graph");
        image.src = 'http://freeflightwx.com/acthpa/springhill/windgraph.php?time=600&window=600&width=780&height=500&max=0&min=0&bol=0&markers=1&error=1&average=0&point=3&timeDisplay=true&rand=' + Math.random();
        count--;
        if(count <= 0){
            toggleOff();
        }
    }
    function toggleOff() {
        $('#toggle').prop('checked', false).change()
    }
    window.onload = function() {
        startRefresh();
    }
   
    function GetCurrentPageName() {
        //method to get Current page name from url.
        var PageURL = document.location.href;
        var PageName = PageURL.substring(PageURL.lastIndexOf('/') + 1);
        return PageName.toLowerCase() ;
    }
    
    function pad(num){
        return ('0'+num).slice(-2);
        
    }
    $(document).ready(function(){
        var CurrPage = GetCurrentPageName();
        switch(CurrPage){
            case 'index.php':
                $('#li_index').addClass('active') ;
                break;
            case '15mins.php':
                $('#li_15mins').addClass('active') ;
                break;
            case '1hour.php':
                $('#li_1hour').addClass('active') ;
                break;
            case '4hours.php':
                $('#li_4hours').addClass('active') ;
                break;
            case '12hours.php':
                $('#li_12hours').addClass('active') ;
                break;
            case 'day.php':
                $('#li_day').addClass('active') ;
                break;
            case 'table.php?h=1':
                $('#table').addClass('active') ;
                break;
        }
        
         $('#toggle').change(function(){
            if($('#toggle').is(':checked')) {
                updateImage();
                startRefresh();
            }
            else {
                stopRefresh();
            }
        });

        // Theme colours
        const colorDanger      = '#ff0000';
        const colorDangerMid   = '#ff6969';
        const colorDangerBg    = '#ffd1d1';
        const colorMarginal    = '#ffa700';
        const colorMarginalMid = '#ffcb69';
        const colorMarginalBg  = '#ffefd1';
        const colorOn          = '#008100';
        const colorOnMid       = '#69b569';
        const colorOnBg        = '#d1e8d1';
        const colorLow         = '#88cfec';
        const colorLowMid      = '#b9e2f4';
        const colorLowBg       = '#e9f5fb';
        const colorWorm        = '#a56106';
        const colorFloor       = '#5381f2';
        const colorPeak        = '#ff7de3';
        const colorDirOn       = '#008100';
        const colorDirOff      = '#8c4521';
        const colorDir         = '#ffff00';

        // Other drawing constants
        const mphHeadroom = 4; // How many mph to graph above the maximum shown, so the peak doesn't touch the top of the graph

        // Sites
        const springHill = {
          name:             'Spring Hill',
          timezone:         'Australia/Sydney',
          speedLowMph:      13,
          speedOnMph:       18,
          speedMarginalMph: 22,
          speedMaxMph:      150, // max recordable wind speed to cancel out electrical interference
          dirOnDeg:         280,
          dirWidthDeg:      45,
          altitudeFt:       2870,
          dirAdjust:        0
        };

        // Utility functions
        function mphToKt(mph) { return mph * 0.8689758; }
        function mphToKmh(mph) { return mph * 1.609344; }
        function clamp(x, l, h) { return Math.max(l, Math.min(h, x)); }

        // Copyright 2021 Observable, Inc.
        // Released under the ISC license.
        // https://observablehq.com/@d3/line-chart
        function WindStrengthGraph(data, {
          site = springHill,
          time,
          windMph,
          windMinMph,
          windMaxMph,
          defined, // for gaps in data
          curve = d3.curveBumpX, // method of interpolation between points
          marginTop = 20, // top margin, in pixels
          marginRight = 40, // right margin, in pixels
          marginBottom = 30, // bottom margin, in pixels
          marginLeft = 30, // left margin, in pixels
          width = 640, // outer width, in pixels
          height = 400, // outer height, in pixels
          xDomain, // [xmin, xmax]
          xRange = [marginLeft, width - marginRight], // [left, right]
          yRange = [height - marginBottom, marginTop], // [bottom, top]
          yFormat, // a format specifier string for the y-axis
          strokeLinecap = "round", // stroke line cap of the line
          strokeLinejoin = "round", // stroke line join of the line
          strokeWidth = 1.5, // stroke width of line, in pixels
          strokeOpacity = 1, // stroke opacity of line
        } = {}) {
          // Compute values.
          const Time = d3.map(data, time);
          const WindMph = d3.map(data, windMph);
          const WindMinMph = d3.map(data, windMinMph);
          const WindMaxMph = d3.map(data, windMaxMph);
          const I = d3.range(Time.length);

          const widthGraph = width - marginRight - marginLeft;
          const heightGraph = height - marginTop - marginBottom;

          // Compute default domains.
          if (xDomain === undefined) xDomain = d3.extent(Time);

          // Scale up to at least the marginal wind strength, or the max wind strength shown, but no more than the site max.
          const graphMaxMph = Math.min(site.speedMaxMph, Math.max(d3.max(WindMaxMph) + mphHeadroom, site.speedMarginalMph));
          const mphDomain = [0, graphMaxMph];
          const ktDomain = [0, mphToKt(graphMaxMph)];
          const kmhDomain = [0, mphToKmh(graphMaxMph)];

          // Construct scales and axes.
          const xScale = d3.scaleTime(xDomain, xRange);
          const mphScale = d3.scaleLinear(mphDomain, yRange);
          const ktScale = d3.scaleLinear(ktDomain, yRange);
          const kmhScale = d3.scaleLinear(kmhDomain, yRange);
          const xAxis = d3.axisBottom(xScale).ticks(width / 80).tickSizeOuter(0);
          const ktAxis = d3.axisRight(ktScale).ticks(height / 20, yFormat);
          const kmhAxis = d3.axisRight(kmhScale).ticks(height / 20, yFormat);

          const svg = d3.create("svg")
              .attr("width", width)
              // .attr("height", height)
              .attr("viewBox", [0, 0, width, height])
              .attr("style", "max-width: 100%; height: auto; height: intrinsic;");

          svg.append("g")
              .attr("transform", `translate(0,${height - marginBottom})`)
              .call(xAxis);

          // Show the kt y axis
          svg.append("g")
              .attr("transform", `translate(${width - marginRight / 2},0)`)
              .call(ktAxis)
              .call(g => g.select(".domain").remove())
              .call(g => g.selectAll(".tick line").clone()
                  .attr("x2", width - marginLeft - marginRight / 2)
                  .attr("stroke-opacity", 0.1))
              .call(g => g.append("text")
                  .attr("x", marginRight / 4)
                  .attr("y", 10)
                  .attr("fill", "currentColor")
                  .attr("text-anchor", "start")
                  .attr("font-weight", "bold")
                  .text("kt"));

          // Show the kmh y axis
          svg.append("g")
              .attr("transform", `translate(${width - marginRight},0)`)
              .call(kmhAxis)
              //.call(g => g.select(".domain").remove())
              .call(g => g.selectAll(".tick line").clone()
                  .attr("x2", width - marginLeft - marginRight)
                  .attr("stroke-opacity", 0.1))
              .call(g => g.append("text")
                  .attr("x", 0)
                  .attr("y", 10)
                  .attr("fill", "currentColor")
                  .attr("text-anchor", "start")
                  .attr("font-weight", "bold")
                  .text("kmh"));

         // Define the low zone clip path
         svg.append("clipPath")
             .attr("id", "clip-low")
             .append("rect")
                 .attr("x", marginLeft)
                 .attr("y", mphScale(site.speedLowMph))
                 .attr("width", widthGraph)
                 .attr("height", mphScale(0) - mphScale(site.speedLowMph));

         // Define the on zone clip path
         svg.append("clipPath")
             .attr("id", "clip-on")
             .append("rect")
                 .attr("x", marginLeft)
                 .attr("y", mphScale(site.speedOnMph))
                 .attr("width", widthGraph)
                 .attr("height", mphScale(site.speedLowMph) - mphScale(site.speedOnMph));

         // Define the marginal zone clip path
         svg.append("clipPath")
             .attr("id", "clip-marginal")
             .append("rect")
                 .attr("x", marginLeft)
                 .attr("y", mphScale(site.speedMarginalMph))
                 .attr("width", widthGraph)
                 .attr("height", mphScale(site.speedOnMph) - mphScale(site.speedMarginalMph));

         // Define the danger zone clip path
         svg.append("clipPath")
             .attr("id", "clip-danger")
             .append("rect")
                 .attr("x", marginLeft)
                 .attr("y", mphScale(graphMaxMph))
                 .attr("width", widthGraph)
                 .attr("height", mphScale(site.speedMarginalMph) - mphScale(graphMaxMph));

         // Draw the danger zone background
         svg.append("rect")
             .attr("fill", colorDangerBg)
             .attr("clip-path", "url(#clip-danger)")
             .attr("x", 0)
             .attr("y", 0)
             .attr("width", width)
             .attr("height", height);

         // Draw the marginal zone background
         svg.append("rect")
             .attr("fill", colorMarginalBg)
             .attr("clip-path", "url(#clip-marginal)")
             .attr("x", 0)
             .attr("y", 0)
             .attr("width", width)
             .attr("height", height);

         // Draw the on zone background
         svg.append("rect")
             .attr("fill", colorOnBg)
             .attr("clip-path", "url(#clip-on)")
             .attr("x", 0)
             .attr("y", 0)
             .attr("width", width)
             .attr("height", height);

         // Draw the low zone background
         svg.append("rect")
             .attr("fill", colorLowBg)
             .attr("clip-path", "url(#clip-low)")
             .attr("x", 0)
             .attr("y", 0)
             .attr("width", width)
             .attr("height", height);

         // Define the current wind band (between each sample's low and high)
         const windArea = d3.area()
             .curve(curve)
             .x(i => xScale(Time[i]))
             .y0(i => mphScale(WindMinMph[i]))
             .y1(i => mphScale(WindMaxMph[i]));

         // Define the area below the current wind band
         const windAreaBelow = d3.area()
             .curve(curve)
             .x(i => xScale(Time[i]))
             .y0(mphScale(0))
             .y1(i => mphScale(WindMinMph[i]));

         // Draw the low zone wind below the band
         svg.append("path")
             .attr("fill", colorLowMid)
             .attr("stroke", "none")
             .attr("clip-path", "url(#clip-low)")
             .attr("d", windAreaBelow(I));

         // Draw the low zone wind band
         svg.append("path")
             .attr("fill", colorLow)
             .attr("stroke", "none")
             .attr("clip-path", "url(#clip-low)")
             .attr("d", windArea(I));

         // Draw the on zone wind below the band
         svg.append("path")
             .attr("fill", colorOnMid)
             .attr("stroke", "none")
             .attr("clip-path", "url(#clip-on)")
             .attr("d", windAreaBelow(I));

         // Draw the on zone wind band
         svg.append("path")
             .attr("fill", colorOn)
             .attr("stroke", "none")
             .attr("clip-path", "url(#clip-on)")
             .attr("d", windArea(I));

         // Draw the marginal zone wind below the band
         svg.append("path")
             .attr("fill", colorMarginalMid)
             .attr("stroke", "none")
             .attr("clip-path", "url(#clip-marginal)")
             .attr("d", windAreaBelow(I));

         // Draw the marginal zone wind band
         svg.append("path")
             .attr("fill", colorMarginal)
             .attr("stroke", "none")
             .attr("clip-path", "url(#clip-marginal)")
             .attr("d", windArea(I));

         // Draw the danger zone wind below the band

         svg.append("path")
             .attr("fill", colorDangerMid)
             .attr("stroke", "none")
             .attr("clip-path", "url(#clip-danger)")
             .attr("d", windAreaBelow(I));

         // Draw the danger zone wind band
         svg.append("path")
             .attr("fill", colorDanger)
             .attr("stroke", "none")
             .attr("clip-path", "url(#clip-danger)")
             .attr("d", windArea(I));

          // Draw the wind line
          // const windLine = d3.line()
          //     .curve(curve)
          //     .curve(curve)
          //     .x(i => xScale(Time[i]))
          //     .y(i => mphScale(WindMph[i]));
          // svg.append("path")
          //     .attr("fill", "none")
          //     .attr("stroke", colorWorm)
          //     .attr("stroke-width", strokeWidth)
          //     .attr("stroke-linecap", strokeLinecap)
          //     .attr("stroke-linejoin", strokeLinejoin)
          //     .attr("stroke-opacity", strokeOpacity)
          //     .attr("stroke-miterlimit", 1)
          //     .attr("d", windLine(I));

          // Draw the min wind line
          //const minWindLine = d3.line()
          //    .curve(curve)
          //    .curve(curve)
          //    .x(i => xScale(Time[i]))
          //    .y(i => mphScale(WindMinMph[i]));
          //svg.append("path")
          //    .attr("fill", "none")
          //    .attr("stroke", colorFloor)
          //    .attr("stroke-width", strokeWidth)
          //    .attr("stroke-linecap", strokeLinecap)
          //    .attr("stroke-linejoin", strokeLinejoin)
          //    .attr("stroke-opacity", strokeOpacity)
          //    .attr("stroke-miterlimit", 1)
          //    .attr("d", minWindLine(I));


          return svg.node();
        }

        d3.json("https://cors-anywhere.herokuapp.com/http://freeflightwx.com/acthpa/springhill/rawjson2.php?r=300").then(function(data) {
            console.log(data[0]);
            // const times = d3.map(data, d => d.time);
            // const windSpeedsMph = d3.map(data, d => d.Windspeedmph);
            // const windSpeedsMphMax = d3.map(data, d => d.WindspeedmphMax);
            // const windSpeedsMphMin = d3.map(data, d => d.WindspeedmphMin);
            // const windDirections = d3.map(data, d.Winddir);

            chart = WindStrengthGraph(data, {
              time: d => d3.timeParse("%Y-%m-%d %H:%M:%S")(d.time),
              windMph: d => parseInt(d.Windspeedmph),
              windMinMph: d => parseInt(d.WindspeedmphMin),
              windMaxMph: d => parseInt(d.WindspeedmphMax),
              width: 1024,
              height: 400,
            });

            d3.select("#graph")
              .node()
              .appendChild(chart);
        });
    });
</script>
<div class="container">
<!-- Static navbar -->
<nav class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../">Home</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li id="li_index"><a href="index.php">Current</a></li>
                <!--<li id="li_15mins"><a href="15mins.php">15 Mins</a></li>-->
                <li id="li_1hour"><a href="1hour.php">1 Hour</a></li>
                <li id="li_4hours"><a href="4hours.php">4 Hours</a></li>
                <li id="li_12hours"><a href="12hours.php">12 Hours</a></li>
                <li id="li_day"><a href="day.php">Day</a></li>
                <li id="li_table"><a href="table.php?h=24">Table</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>
<h3>Spring Hill Weather Station</h3>
</div>
<!--
<div class="container">
    <div class="checkbox">
        <label>
            <input id="toggle" type="checkbox" checked data-toggle="toggle" data-size="mini" data-onstyle="info" data-offstyle="warning">
            Auto refresh (every 3 seconds)
        </label>
    </div>
</div>
-->
<div class="container" id="graph">
  
</div>
<div class="container" id="table">
    
</div>
</body>
</html>

